@model System.Collections.Generic.IEnumerable<FamousQuoteQuiz.Dal.Models.User>

@{
    Layout = "_Layout";
}

<h2>User management</h2>
<button onclick="openModal(null)" class="btn btn-info">Add new user</button>
<table class="table table-hover">
    <caption>List of users</caption>
    <thead class="thead-dark">
    <tr>
        <th></th>
        <th>#</th>
        <th>Name</th>
        <th>Prefered question type</th>
        <th>Created at</th>
    </tr>
    </thead>
    <tbody>
    @{
        foreach (var user in Model)
        {
            var isAdmin = user.Name == "admin";
            var rowColorClass = string.Empty;
            var disabled = string.Empty;
            if (isAdmin)
            {
                rowColorClass = "class=table-danger";
                disabled = "disabled";
            }
            <tr @rowColorClass id="@user.Id">
                <td>
                    <button class="edit" @disabled onclick="openModal(@user.Id)"></button>
                    <button class="delete" @disabled onclick="deleteUser(@user.Id)"></button>
                </td>
                <td>@user.Id</td>
                <td>@user.Name</td>
                <td>@user.QuestionType.ToString()</td>
                <td>@user.CreatedAt.ToString("s")</td>
            </tr>
        }
    }
    </tbody>
</table>

<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button onclick="closeModal()" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="form">
                    <div class="form-group" id="idFormGroup">
                        <label for="userId">Id: </label>
                        <input type="text" readonly class="form-control-plaintext" id="userId" value="your id">
                    </div>
                    <div class="form-group">
                        <label for="userNameInput">Name: </label>
                        <input type="text" class="form-control" id="userNameInput" aria-describedby="userNameHelp" name="Name">
                    </div>
                    <div class="form-group">
                        <label for="questionTypeSelect">Question type: </label>
                        <select class="form-control" id="questionTypeSelect" name="QuestionType">
                            <option data-id="0">Binary</option>
                            <option data-id="1">Multiple choice</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="saveChanges()" type="button" class="saveEdit btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    function deleteUser(id) {
        $.ajax(`/user/delete/${id}`, {
            success: function (){
                $(`#${id}`).remove();
                alert("Deleted!");
            }
        });
    }

    var isAddSelected = true;

    function closeModal(){
        $("#editUserModal").modal("hide");
    }
    
    function openModal(id){
        isAddSelected = !id;
        $("#editUserModal").modal("show");
        $("#modalTitle").text(isAddSelected ? "Add user" : "Edit user");
        $("#idFormGroup").css("display", isAddSelected ? "none" : "block");
        
        let userId = $(`#${id} td:nth-child(2)`).text();
        let userName = $(`#${id} td:nth-child(3)`).text();
        let questionType = $(`#${id} td:nth-child(4)`).text();
        $("#userId").val(userId);
        $("#userNameInput").val(userName);
        if (isAddSelected) {
            $(`#questionTypeSelect option:nth-child(1)`).attr('selected', 'selected');
        } else {
            $(`#questionTypeSelect option:nth-child(${(questionType === 'Binary' ? 1 : 2)})`).attr('selected', 'selected');
        }
    }
    
    function saveChanges(){
        $.ajax(`/user/${(isAddSelected ? "add" : "update")}`, {
                    timeout: 500,
                    type: isAddSelected ? "POST" : "PUT",
                    data: {
                        "UserId": 1,
                        "QuestionType" : 0,
                        "Name" : ""
                    },
                    success: function(data, status, xhr){
                        closeModal();
                        alert("Saved!");
                        @*put the edited values back*@
                    }
                });
    }
</script>